# Deployment Guide: Liquid Level Monitor

## Prerequisites

```bash
# Install Nginx
sudo apt update
sudo apt install nginx -y

# Install Certbot for SSL (Let's Encrypt)
sudo apt install certbot python3-certbot-nginx -y

# Install Python dependencies (for backend)
pip install fastapi uvicorn opencv-python-headless numpy pandas matplotlib scipy scikit-learn scikit-image openpyxl
```

---

## Step 1: Backend Setup (FastAPI)

### 1.1 Create a systemd service for the backend

```bash
sudo nano /etc/systemd/system/liquidlevel.service
```

Add the following content:

```ini
[Unit]
Description=Liquid Level Monitor Backend
After=network.target

[Service]
User=www-data
Group=www-data
WorkingDirectory=/apps/workspace/tt
ExecStart=/usr/bin/python3 -m uvicorn main:app --host 127.0.0.1 --port 8000
Restart=always
RestartSec=3
Environment="PATH=/usr/bin"

[Install]
WantedBy=multi-user.target
```

### 1.2 Enable and start the service

```bash
sudo systemctl daemon-reload
sudo systemctl enable liquidlevel
sudo systemctl start liquidlevel
sudo systemctl status liquidlevel
```

---

## Step 2: Frontend Setup (Vue.js)

### 2.1 Update the backend URL in frontend

In your `frontendcode` (Vue component), update the `backendUrl`:

```javascript
// Change this line:
const backendUrl = "https://hire.aayushkundalwal.tech"

// To your domain:
const backendUrl = "https://xyz.com"  // or "https://xyz.com/api" if using subpath
```

### 2.2 Build and deploy the frontend

```bash
# If using Vue CLI:
npm install
npm run build

# Copy dist folder to nginx web root
sudo cp -r dist/* /var/www/xyz.com/html/
```

---

## Step 3: Nginx Configuration

### 3.1 Create Nginx site configuration

```bash
sudo nano /etc/nginx/sites-available/xyz.com
```

Add the following configuration:

```nginx
# Upstream for FastAPI backend
upstream liquidlevel_backend {
    server 127.0.0.1:8000;
    keepalive 64;
}

server {
    listen 80;
    server_name xyz.com www.xyz.com;

    # Redirect HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name xyz.com www.xyz.com;

    # ===========================================
    # SSL Configuration (Certbot will fill these)
    # ===========================================
    ssl_certificate /etc/letsencrypt/live/xyz.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/xyz.com/privkey.pem;
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:50m;
    ssl_session_tickets off;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;

    # ===========================================
    # IMPORTANT: Increase body size for video uploads
    # ===========================================
    client_max_body_size 500M;
    client_body_timeout 600s;
    client_body_buffer_size 128k;

    # ===========================================
    # Frontend (Static Vue.js files)
    # ===========================================
    root /var/www/xyz.com/html;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    # ===========================================
    # Backend API - Regular endpoints
    # ===========================================
    location /api/ {
        # Remove /api prefix when proxying
        rewrite ^/api/(.*) /$1 break;

        proxy_pass http://liquidlevel_backend;
        proxy_http_version 1.1;

        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts for regular requests
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ===========================================
    # VIDEO FEED - CRITICAL: Streaming Configuration
    # ===========================================
    location /api/video_feed {
        rewrite ^/api/(.*) /$1 break;

        proxy_pass http://liquidlevel_backend;
        proxy_http_version 1.1;

        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";

        # *** CRITICAL FOR LIVE STREAMING ***
        proxy_buffering off;           # Disable buffering for real-time stream
        proxy_cache off;               # No caching
        proxy_request_buffering off;   # Don't buffer request body

        # Extended timeouts for long-lived streaming connection
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;       # Keep connection alive for 10 minutes

        # Disable gzip for streaming content
        gzip off;

        # Chunked transfer encoding
        chunked_transfer_encoding on;
    }

    # ===========================================
    # VIDEO UPLOAD - Large file handling
    # ===========================================
    location /api/upload_video {
        rewrite ^/api/(.*) /$1 break;

        proxy_pass http://liquidlevel_backend;
        proxy_http_version 1.1;

        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # *** CRITICAL FOR LARGE UPLOADS ***
        client_max_body_size 500M;     # Allow up to 500MB video files
        proxy_request_buffering off;   # Stream upload directly to backend

        # Extended timeouts for large uploads
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
    }

    # ===========================================
    # Download endpoint
    # ===========================================
    location /api/download_report {
        rewrite ^/api/(.*) /$1 break;

        proxy_pass http://liquidlevel_backend;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Allow large file downloads
        proxy_buffering on;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
    }

    # ===========================================
    # Security Headers
    # ===========================================
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
}
```

### 3.2 Alternative: Backend at root (no /api prefix)

If you want the backend directly at `xyz.com` without `/api` prefix:

```nginx
server {
    listen 443 ssl http2;
    server_name xyz.com;

    # SSL config...

    client_max_body_size 500M;
    client_body_timeout 600s;

    # ===========================================
    # Video streaming - MUST be before general proxy
    # ===========================================
    location = /video_feed {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Connection "";

        # CRITICAL for streaming
        proxy_buffering off;
        proxy_cache off;
        proxy_request_buffering off;

        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;

        gzip off;
        chunked_transfer_encoding on;
    }

    # ===========================================
    # Video upload
    # ===========================================
    location = /upload_video {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        client_max_body_size 500M;
        proxy_request_buffering off;

        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
    }

    # ===========================================
    # All other API endpoints
    # ===========================================
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
```

---

## Step 4: Enable Site and Get SSL

### 4.1 Enable the site

```bash
sudo ln -s /etc/nginx/sites-available/xyz.com /etc/nginx/sites-enabled/

# Test configuration
sudo nginx -t

# Reload nginx
sudo systemctl reload nginx
```

### 4.2 Get SSL certificate with Certbot

```bash
# Get certificate (this will auto-configure nginx)
sudo certbot --nginx -d xyz.com -d www.xyz.com

# Test auto-renewal
sudo certbot renew --dry-run
```

---

## Step 5: Firewall Configuration

```bash
# Allow HTTP and HTTPS
sudo ufw allow 'Nginx Full'

# Check status
sudo ufw status
```

---

## Troubleshooting

### Issue 1: Video feed not loading / buffering issues

**Symptoms:** Video feed is choppy, delayed, or not loading

**Solution:** Ensure these directives are in your video_feed location:
```nginx
proxy_buffering off;
proxy_cache off;
proxy_request_buffering off;
gzip off;
```

### Issue 2: Video upload fails with 413 error

**Symptoms:** "Request Entity Too Large" error

**Solution:** Increase these values:
```nginx
client_max_body_size 500M;  # In http, server, or location block
```

### Issue 3: Connection timeout during streaming

**Symptoms:** Video feed disconnects after some time

**Solution:** Increase timeout values:
```nginx
proxy_read_timeout 3600s;  # 1 hour for long sessions
```

### Issue 4: Camera not accessible

**Symptoms:** "Camera not found" error

**Solution:**
```bash
# Check if www-data can access video devices
sudo usermod -a -G video www-data

# Restart the service
sudo systemctl restart liquidlevel

# Verify camera permissions
ls -la /dev/video*
```

### Issue 5: CORS errors in browser

**Symptoms:** Cross-origin request blocked

**Solution:** Add CORS headers in nginx:
```nginx
location /api/ {
    # ... existing config ...

    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range' always;

    if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
        add_header 'Access-Control-Max-Age' 1728000;
        add_header 'Content-Type' 'text/plain; charset=utf-8';
        add_header 'Content-Length' 0;
        return 204;
    }
}
```

---

## Nginx Config Summary: Key Settings for Streaming

| Setting | Value | Purpose |
|---------|-------|---------|
| `proxy_buffering` | `off` | Real-time video streaming |
| `proxy_cache` | `off` | No caching for live feed |
| `proxy_read_timeout` | `600s+` | Long-lived connections |
| `client_max_body_size` | `500M` | Large video uploads |
| `gzip` | `off` | Don't compress binary stream |
| `chunked_transfer_encoding` | `on` | Streaming support |

---

## Quick Commands Reference

```bash
# Check nginx config
sudo nginx -t

# Reload nginx
sudo systemctl reload nginx

# View nginx error log
sudo tail -f /var/log/nginx/error.log

# View backend logs
sudo journalctl -u liquidlevel -f

# Restart backend
sudo systemctl restart liquidlevel

# Check if backend is running
curl http://localhost:8000/

# Test video feed
curl -I http://localhost:8000/video_feed
```

---

## Directory Structure

```
/apps/workspace/tt/
├── main.py              # FastAPI application
├── camera_service.py    # Camera/video processing
├── detector.py          # Edge detection
├── analyzer.py          # Result analysis
├── uploaded_videos/     # Uploaded video files (created at runtime)
└── session_output/      # Output reports (created at runtime)

/var/www/xyz.com/html/
├── index.html           # Vue.js frontend
├── assets/              # JS/CSS files
└── ...
```
